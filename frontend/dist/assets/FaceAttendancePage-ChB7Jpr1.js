import{r as a,j as e,u as z,L as J}from"./index-nuNE0MbF.js";import{a as k,r as $,s as B,f as O,c as F,p as Y,l as W,b as X,d as G,g as Z,h as _}from"./payrollService-li453Ssr.js";const ee=({onCameraReady:d,onCameraError:h},n)=>{const m=a.useRef(null),[v,l]=a.useState("dang-tai"),[f,u]=a.useState("");return a.useImperativeHandle(n,()=>({getVideoElement:()=>m.current}),[]),a.useEffect(()=>{let x=null;return(async()=>{try{if(!navigator.mediaDevices?.getUserMedia)throw new Error("Trình duyệt không hỗ trợ camera.");x=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}),m.current&&(m.current.srcObject=x,await m.current.play()),l("san-sang"),d?.()}catch(g){const b=g instanceof Error?g.message:"Không thể truy cập camera.";l("loi"),u(b),h?.(b)}})(),()=>{x&&x.getTracks().forEach(g=>g.stop())}},[d,h]),e.jsxs("div",{className:"flex h-full flex-col text-slate-500",children:[e.jsxs("div",{className:"relative flex-1 overflow-hidden rounded-2xl bg-black/90 shadow-inner",children:[e.jsx("video",{ref:m,className:"h-full w-full object-cover",autoPlay:!0,muted:!0,playsInline:!0}),v!=="san-sang"&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-black/60 text-white",children:[e.jsx("div",{className:"h-10 w-10 animate-spin rounded-full border-4 border-white/40 border-t-white"}),e.jsx("p",{className:"mt-4 text-sm font-semibold",children:v==="dang-tai"?"Đang khởi động camera...":f})]})]}),e.jsx("p",{className:"mt-3 text-xs text-slate-400",children:"Camera dùng để nhận diện khuôn mặt. Hãy đứng trong vùng sáng và nhìn thẳng vào camera."})]})},te=a.forwardRef(ee),ne=()=>{const d=localStorage.getItem("employeesData");if(d)try{const h=JSON.parse(d);if(Array.isArray(h))return h.map(n=>{const m=typeof n.baseSalary=="number"?n.baseSalary:Number(n.salary)||0;return{...n,baseSalary:m}})}catch(h){console.warn("Không đọc được employeesData:",h)}return[{id:"1",code:"PKDN0001",name:"Nguyễn Minh Anh",dept:"Phòng Kinh Doanh",position:"Nhân viên",baseSalary:1e7,status:"active",visible:!0},{id:"2",code:"PTPT0002",name:"Nguyễn Minh Tạo",dept:"Trưởng phòng",position:"Trưởng phòng",baseSalary:2e7,status:"active",visible:!0},{id:"3",code:"PCKN0003",name:"Trần Quỳnh",dept:"Chăm sóc KH",position:"Nhân viên",baseSalary:12e6,status:"inactive",visible:!0}]},q=d=>`activeCheckIn:${d}`,oe=()=>{const d=z(),[h]=a.useState(ne),[n,m]=a.useState(null),[v,l]=a.useState(null),[f,u]=a.useState(null),[x,w]=a.useState(!1),[g,b]=a.useState(!1),K=a.useRef(null),[T,H]=a.useState([]),[R,C]=a.useState(0),[L,I]=a.useState(!1),D=a.useCallback(async(t,c)=>{try{const i=await k.fetchAttendanceHistory(t.id);if(i.length){const y=$(i,new Date),p=B(i,y);H(p.history),C(p.monthlyHours),O(t.id,{year:y.getFullYear(),month:y.getMonth()+1,hours:p.monthlyHours,updatedAt:new Date().toISOString()});const E=c??t.baseSalary??0;if(E>0){const S=F(p.monthlyHours,E);Y.upsertMonthlySummary({employeeId:t.id,year:y.getFullYear(),month:y.getMonth()+1,totalHours:p.monthlyHours,overtimeHours:S.overtimeHours,baseSalary:E,overtimePay:S.overtimePay,totalPay:S.projectedSalary,status:S.hasBaseSalary?"approved":"draft"})}return}}catch(i){console.warn("Không tải được lịch sử chấm công từ Supabase.",i)}const r=W(t.id),s=$(r,new Date),o=B(r,s);H(o.history),C(o.monthlyHours),O(t.id,{year:s.getFullYear(),month:s.getMonth()+1,hours:o.monthlyHours,updatedAt:new Date().toISOString()});const N=c??t.baseSalary??0;if(N>0){const i=F(o.monthlyHours,N);Y.upsertMonthlySummary({employeeId:t.id,year:s.getFullYear(),month:s.getMonth()+1,totalHours:o.monthlyHours,overtimeHours:i.overtimeHours,baseSalary:N,overtimePay:i.overtimePay,totalPay:i.projectedSalary,status:i.hasBaseSalary?"approved":"draft"})}},[]),Q=n&&typeof n=="object"?Number(n.salary):void 0,P=n?.baseSalary??Q??0,j=F(R,P);a.useEffect(()=>{const t=localStorage.getItem("attendanceEmployeeId");if(!t){d("/",{replace:!0});return}const c=h.find(r=>r.id===t);c?m(c):d("/",{replace:!0})},[h,d]),a.useEffect(()=>{let t=!0;if(!n){w(!1),H([]),C(0),I(!1);return}(async()=>{const s=await k.hasFaceEnrollment(n.id);t&&w(s)})(),I(!1);const c=q(n.id),r=localStorage.getItem(c);if(r){const s=new Date(r);Number.isNaN(s.getTime())||A(s)}return D(n,n.baseSalary??0),()=>{t=!1}},[n,D]);const[U,A]=a.useState(null),[ae,M]=a.useState(null),V=async t=>{if(!n){l("Không tồn tại nhân viên để chấm công"),u(null),setTimeout(()=>l(null),4e3);return}if(!x){l("Không tìm thấy dữ liệu khuôn mặt. Vui lòng đăng ký trước."),u(null),setTimeout(()=>l(null),4e3);return}const c=K.current?.getVideoElement();if(!c){l("Không tìm thấy camera. Vui lòng kiểm tra lại thiết bị."),u(null),setTimeout(()=>l(null),4e3);return}b(!0);try{const r=await X(c);if(!r.descriptor){l("Không nhận diện được khuôn mặt. Vui lòng đứng gần và thử lại."),u(null),setTimeout(()=>l(null),4e3);return}const s=await k.checkInWithFace({embedding:G(r.descriptor),type:t==="in"?"checkin":"checkout",threshold:.5});if(s.employeeId!==n.id){l("Khuôn mặt không khớp với nhân viên đang chọn."),u(null),setTimeout(()=>l(null),4e3);return}const o=new Date(s.timestamp),N=t==="in"?`Check-in thành công lúc ${o.toLocaleTimeString("vi-VN")} (độ khớp ${s.distance.toFixed(3)})`:`Check-out thành công lúc ${o.toLocaleTimeString("vi-VN")} (độ khớp ${s.distance.toFixed(3)})`;l(N),u(t),setTimeout(()=>l(null),4e3);const i=U;let y;const p=q(n.id);if(t==="in")localStorage.setItem(p,o.toISOString()),A(o),M(null);else{if(!i)return;M(o),y=Z(i,o),localStorage.removeItem(p),A(null)}k.saveAttendanceEvent({employeeId:n.id,type:t==="in"?"checkin":"checkout",timestamp:o.toISOString(),distance:s.distance,threshold:s.threshold,source:s.source}),_(n.id,{id:`${n.id}-${o.getTime()}-${t}`,type:t==="in"?"checkin":"checkout",timestamp:o.toISOString(),durationHours:y}),await D(n,P)}catch(r){const s=r instanceof Error?r.message:"Không thể chấm công bằng khuôn mặt.";l(s),u(null),setTimeout(()=>l(null),4e3)}finally{b(!1)}};return e.jsx("div",{className:"trang-cham-cong",children:e.jsxs("div",{className:"khung-noi-dung-cham-cong",children:[e.jsxs("header",{className:"phan-dau-cham-cong",children:[e.jsx("h1",{className:"tieu-de-cham-cong",children:"Chấm công bằng khuôn mặt"}),e.jsx("button",{type:"button",className:"nut-quay-lai",onClick:()=>{localStorage.removeItem("attendanceEmployeeId"),d("/")},children:"Đổi tài khoản"})]}),e.jsxs("section",{className:"noi-dung-cham-cong",children:[e.jsxs("div",{className:"khoi-camera",children:[e.jsx("div",{className:"khung-camera",children:e.jsx(te,{ref:K})}),v&&e.jsx("div",{className:`thong-bao ${f==="in"?"thong-bao-thanh-cong":"thong-bao-thong-tin"}`,children:v}),e.jsxs("div",{className:"Nut-xac-nhan",children:[e.jsx("button",{className:"nut-check-in",onClick:()=>V("in"),disabled:g,children:g?"Đang xử lý...":"Check-in"}),e.jsx("button",{className:"nut-check-out",onClick:()=>V("out"),disabled:g,children:g?"Đang xử lý...":"Check-out"})]})]}),e.jsx("div",{className:"thong-tin-nhan-vien",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"nhan-nho",children:"Thông tin nhân viên"}),e.jsx("h2",{className:"ten-nhan-vien",children:n.name}),e.jsx("p",{className:"chuc-vu",children:n.position})]}),e.jsxs("dl",{className:"bang-thong-tin",children:[e.jsxs("div",{children:[e.jsx("dt",{children:"Mã nhân viên"}),e.jsx("dd",{children:n.code})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Bộ phận"}),e.jsx("dd",{children:n.dept})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Nhận diện khuôn mặt"}),e.jsx("dd",{className:x?"text-green-600 font-semibold":"text-red-600 font-semibold",children:x?"Đã đăng ký":"Chưa đăng ký"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Trạng thái"}),e.jsx("dd",{className:f==="out"?"trang-thai-xam":"trang-thai-xanh",children:f==="out"?"Đã check-out":"Đang làm việc"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"button",className:"rounded-full bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200 transition",onClick:()=>I(t=>!t),children:L?"Ẩn lịch sử & thống kê":"Xem lịch sử, chấm công & tổng lương"})}),L&&e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"grid gap-3 rounded-2xl border border-slate-100 bg-white p-4 shadow-sm md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-xl bg-slate-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Tổng số giờ đã làm"}),e.jsxs("p",{className:"text-2xl font-bold text-slate-900 mt-1",children:[R.toFixed(2),"h"]})]}),e.jsxs("div",{className:"rounded-xl bg-slate-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Tổng lần chấm công"}),e.jsx("p",{className:"text-2xl font-bold text-slate-900 mt-1",children:T.length})]}),e.jsxs("div",{className:"rounded-xl bg-slate-50 p-3 md:col-span-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Tổng tiền lương dự kiến"}),e.jsxs("p",{className:"text-3xl font-bold text-emerald-600 mt-1 break-words",children:[j.projectedSalary.toLocaleString("vi-VN"),"₫"]}),e.jsx("p",{className:"text-[11px] text-slate-500 mt-1",children:j.hasBaseSalary?j.overtimeHours>0?`Bao gồm ${j.overtimeHours.toFixed(2)}h làm thêm (+${j.overtimePay.toLocaleString("vi-VN")}₫)`:"Đã đủ 40 giờ, hiển thị lương cơ bản":"Chưa đủ 40 giờ để nhận lương cơ bản"})]})]}),e.jsxs("div",{className:"rounded-2xl border border-slate-100 bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-700 mb-3",children:"Lịch sử chấm công gần đây"}),T.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Chưa có dữ liệu chấm công."}):e.jsx("ul",{className:"space-y-2 max-h-60 overflow-y-auto pr-1",children:T.slice(0,8).map(t=>{const c=new Date(t.timestamp);return e.jsxs("li",{className:"flex items-center justify-between rounded-xl bg-slate-50 px-4 py-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-900",children:t.type==="checkin"?"Check-in":"Check-out"}),e.jsxs("p",{className:"text-xs text-slate-500",children:[c.toLocaleDateString("vi-VN")," • ",c.toLocaleTimeString("vi-VN")]})]}),typeof t.durationHours=="number"&&t.durationHours>0&&e.jsxs("span",{className:"text-xs font-semibold text-emerald-600",children:["+",t.durationHours.toFixed(2),"h"]})]},t.id)})})]})]})]}):e.jsx("p",{children:"Không tìm thấy thông tin đăng nhập. Vui lòng quay lại trang chủ và đăng nhập lại để chấm công."})})]}),e.jsx("footer",{className:"chan-trang-cham-cong",children:e.jsx(J,{to:"/",className:"nut-quay-lai",children:"← Quay lại trang chủ"})})]})})};export{oe as default};
