import{r as a,j as e,s as E,u as Y,L as Q}from"./index-D0kGtGIa.js";import{a as k,s as V,c as P,l as U,b as z,d as J,e as W,f as X}from"./faceRecognition-DmqH_ObE.js";const G=({onCameraReady:s,onCameraError:r},t)=>{const i=a.useRef(null),[y,l]=a.useState("dang-tai"),[v,u]=a.useState("");return a.useImperativeHandle(t,()=>({getVideoElement:()=>i.current}),[]),a.useEffect(()=>{let x=null;return(async()=>{try{if(!navigator.mediaDevices?.getUserMedia)throw new Error("Trình duyệt không hỗ trợ camera.");x=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}),i.current&&(i.current.srcObject=x,await i.current.play()),l("san-sang"),s?.()}catch(g){const b=g instanceof Error?g.message:"Không thể truy cập camera.";l("loi"),u(b),r?.(b)}})(),()=>{x&&x.getTracks().forEach(g=>g.stop())}},[s,r]),e.jsxs("div",{className:"flex h-full flex-col text-slate-500",children:[e.jsxs("div",{className:"relative flex-1 overflow-hidden rounded-2xl bg-black/90 shadow-inner",children:[e.jsx("video",{ref:i,className:"h-full w-full object-cover",autoPlay:!0,muted:!0,playsInline:!0}),y!=="san-sang"&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-black/60 text-white",children:[e.jsx("div",{className:"h-10 w-10 animate-spin rounded-full border-4 border-white/40 border-t-white"}),e.jsx("p",{className:"mt-4 text-sm font-semibold",children:y==="dang-tai"?"Đang khởi động camera...":v})]})]}),e.jsx("p",{className:"mt-3 text-xs text-slate-400",children:"Camera dùng để nhận diện khuôn mặt. Hãy đứng trong vùng sáng và nhìn thẳng vào camera."})]})},Z=a.forwardRef(G),$={async upsertMonthlySummary(s){try{const{error:r}=await E.from("monthly_payrolls").upsert({employee_id:s.employeeId,year:s.year,month:s.month,total_hours:s.totalHours,overtime_hours:s.overtimeHours,base_salary:s.baseSalary,overtime_pay:s.overtimePay,total_pay:s.totalPay,status:s.status??(s.totalHours>=40?"approved":"draft")},{onConflict:"employee_id,year,month"});if(r)throw r}catch(r){console.warn("Không thể cập nhật monthly_payrolls trên Supabase.",r)}},async fetchMonthlyPayrolls(s,r){const{data:t,error:i}=await E.from("monthly_payrolls").select("*").eq("employee_id",s).eq("year",r).order("month",{ascending:!0});return i?(console.warn("Không lấy được monthly_payrolls.",i),[]):t??[]},async fetchYearOverview(s,r){let t=E.from("monthly_payrolls").select("*, employees!inner(id, full_name)").eq("year",s);typeof r=="number"&&(t=t.eq("month",r));const{data:i,error:y}=await t;return y?(console.warn("Không lấy được báo cáo lương từ Supabase.",y),[]):i??[]}},ee=()=>{const s=localStorage.getItem("employeesData");if(s)try{const r=JSON.parse(s);if(Array.isArray(r))return r.map(t=>{const i=typeof t.baseSalary=="number"?t.baseSalary:Number(t.salary)||0;return{...t,baseSalary:i}})}catch(r){console.warn("Không đọc được employeesData:",r)}return[{id:"1",code:"PKDN0001",name:"Nguyễn Minh Anh",dept:"Phòng Kinh Doanh",position:"Nhân viên",baseSalary:1e7,status:"active",visible:!0},{id:"2",code:"PTPT0002",name:"Nguyễn Minh Tạo",dept:"Trưởng phòng",position:"Trưởng phòng",baseSalary:2e7,status:"active",visible:!0},{id:"3",code:"PCKN0003",name:"Trần Quỳnh",dept:"Chăm sóc KH",position:"Nhân viên",baseSalary:12e6,status:"inactive",visible:!0}]},B=s=>`activeCheckIn:${s}`,ae=()=>{const s=Y(),[r]=a.useState(ee),[t,i]=a.useState(null),[y,l]=a.useState(null),[v,u]=a.useState(null),[x,w]=a.useState(!1),[g,b]=a.useState(!1),F=a.useRef(null),[T,H]=a.useState([]),[L,C]=a.useState(0),[A,I]=a.useState(!1),D=a.useCallback(async(n,d)=>{const o=new Date;try{const m=await k.fetchAttendanceHistory(n.id);if(m.length){const p=V(m,o);H(p.history),C(p.monthlyHours);const f=d??n.baseSalary??0;if(f>0){const S=P(p.monthlyHours,f);$.upsertMonthlySummary({employeeId:n.id,year:o.getFullYear(),month:o.getMonth()+1,totalHours:p.monthlyHours,overtimeHours:S.overtimeHours,baseSalary:f,overtimePay:S.overtimePay,totalPay:S.projectedSalary,status:S.hasBaseSalary?"approved":"draft"})}return}}catch(m){console.warn("Không tải được lịch sử chấm công từ Supabase.",m)}const c=U(n.id),h=V(c,o);H(h.history),C(h.monthlyHours);const N=d??n.baseSalary??0;if(N>0){const m=P(h.monthlyHours,N);$.upsertMonthlySummary({employeeId:n.id,year:o.getFullYear(),month:o.getMonth()+1,totalHours:h.monthlyHours,overtimeHours:m.overtimeHours,baseSalary:N,overtimePay:m.overtimePay,totalPay:m.projectedSalary,status:m.hasBaseSalary?"approved":"draft"})}},[]),q=t&&typeof t=="object"?Number(t.salary):void 0,_=t?.baseSalary??q??0,j=P(L,_);a.useEffect(()=>{const n=localStorage.getItem("attendanceEmployeeId");if(!n){s("/",{replace:!0});return}const d=r.find(o=>o.id===n);d?i(d):s("/",{replace:!0})},[r,s]),a.useEffect(()=>{let n=!0;if(!t){w(!1),H([]),C(0),I(!1);return}(async()=>{const c=await k.hasFaceEnrollment(t.id);n&&w(c)})(),I(!1);const d=B(t.id),o=localStorage.getItem(d);if(o){const c=new Date(o);Number.isNaN(c.getTime())||K(c)}return D(t,t.baseSalary??0),()=>{n=!1}},[t,D]);const[O,K]=a.useState(null),[te,M]=a.useState(null),R=async n=>{if(!t){l("Không tồn tại nhân viên để chấm công"),u(null),setTimeout(()=>l(null),4e3);return}if(!x){l("Không tìm thấy dữ liệu khuôn mặt. Vui lòng đăng ký trước."),u(null),setTimeout(()=>l(null),4e3);return}const d=F.current?.getVideoElement();if(!d){l("Không tìm thấy camera. Vui lòng kiểm tra lại thiết bị."),u(null),setTimeout(()=>l(null),4e3);return}b(!0);try{const o=await z(d);if(!o.descriptor){l("Không nhận diện được khuôn mặt. Vui lòng đứng gần và thử lại."),u(null),setTimeout(()=>l(null),4e3);return}const c=await k.checkInWithFace({embedding:J(o.descriptor),type:n==="in"?"checkin":"checkout",threshold:.5});if(c.employeeId!==t.id){l("Khuôn mặt không khớp với nhân viên đang chọn."),u(null),setTimeout(()=>l(null),4e3);return}const h=new Date(c.timestamp),N=n==="in"?`Check-in thành công lúc ${h.toLocaleTimeString("vi-VN")} (độ khớp ${c.distance.toFixed(3)})`:`Check-out thành công lúc ${h.toLocaleTimeString("vi-VN")} (độ khớp ${c.distance.toFixed(3)})`;l(N),u(n),setTimeout(()=>l(null),4e3);const m=O;let p;const f=B(t.id);if(n==="in")localStorage.setItem(f,h.toISOString()),K(h),M(null);else{if(!m)return;M(h),p=W(m,h),localStorage.removeItem(f),K(null)}k.saveAttendanceEvent({employeeId:t.id,type:n==="in"?"checkin":"checkout",timestamp:h.toISOString(),distance:c.distance,threshold:c.threshold,source:c.source}),X(t.id,{id:`${t.id}-${h.getTime()}-${n}`,type:n==="in"?"checkin":"checkout",timestamp:h.toISOString(),durationHours:p}),await D(t,_)}catch(o){const c=o instanceof Error?o.message:"Không thể chấm công bằng khuôn mặt.";l(c),u(null),setTimeout(()=>l(null),4e3)}finally{b(!1)}};return e.jsx("div",{className:"trang-cham-cong",children:e.jsxs("div",{className:"khung-noi-dung-cham-cong",children:[e.jsxs("header",{className:"phan-dau-cham-cong",children:[e.jsx("h1",{className:"tieu-de-cham-cong",children:"Chấm công bằng khuôn mặt"}),e.jsx("button",{type:"button",className:"nut-quay-lai",onClick:()=>{localStorage.removeItem("attendanceEmployeeId"),s("/")},children:"Đổi tài khoản"})]}),e.jsxs("section",{className:"noi-dung-cham-cong",children:[e.jsxs("div",{className:"khoi-camera",children:[e.jsx("div",{className:"khung-camera",children:e.jsx(Z,{ref:F})}),y&&e.jsx("div",{className:`thong-bao ${v==="in"?"thong-bao-thanh-cong":"thong-bao-thong-tin"}`,children:y}),e.jsxs("div",{className:"Nut-xac-nhan",children:[e.jsx("button",{className:"nut-check-in",onClick:()=>R("in"),disabled:g,children:g?"Đang xử lý...":"Check-in"}),e.jsx("button",{className:"nut-check-out",onClick:()=>R("out"),disabled:g,children:g?"Đang xử lý...":"Check-out"})]})]}),e.jsx("div",{className:"thong-tin-nhan-vien",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"nhan-nho",children:"Thông tin nhân viên"}),e.jsx("h2",{className:"ten-nhan-vien",children:t.name}),e.jsx("p",{className:"chuc-vu",children:t.position})]}),e.jsxs("dl",{className:"bang-thong-tin",children:[e.jsxs("div",{children:[e.jsx("dt",{children:"Mã nhân viên"}),e.jsx("dd",{children:t.code})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Bộ phận"}),e.jsx("dd",{children:t.dept})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Nhận diện khuôn mặt"}),e.jsx("dd",{className:x?"text-green-600 font-semibold":"text-red-600 font-semibold",children:x?"Đã đăng ký":"Chưa đăng ký"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Trạng thái"}),e.jsx("dd",{className:v==="out"?"trang-thai-xam":"trang-thai-xanh",children:v==="out"?"Đã check-out":"Đang làm việc"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{type:"button",className:"rounded-full bg-slate-100 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200 transition",onClick:()=>I(n=>!n),children:A?"Ẩn lịch sử & thống kê":"Xem lịch sử, chấm công & tổng lương"})}),A&&e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"grid gap-3 rounded-2xl border border-slate-100 bg-white p-4 shadow-sm md:grid-cols-3",children:[e.jsxs("div",{className:"rounded-xl bg-slate-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Tổng số giờ đã làm"}),e.jsxs("p",{className:"text-2xl font-bold text-slate-900 mt-1",children:[L.toFixed(2),"h"]})]}),e.jsxs("div",{className:"rounded-xl bg-slate-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Tổng tiền lương dự kiến"}),e.jsxs("p",{className:"text-2xl font-bold text-emerald-600 mt-1",children:[j.projectedSalary.toLocaleString("vi-VN"),"₫"]}),e.jsx("p",{className:"text-[11px] text-slate-500 mt-1",children:j.hasBaseSalary?j.overtimeHours>0?`Bao gồm ${j.overtimeHours.toFixed(2)}h làm thêm (+${j.overtimePay.toLocaleString("vi-VN")}₫)`:"Đã đủ 40 giờ, hiển thị lương cơ bản":"Chưa đủ 40 giờ để nhận lương cơ bản"})]}),e.jsxs("div",{className:"rounded-xl bg-slate-50 p-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Tổng lần chấm công"}),e.jsx("p",{className:"text-2xl font-bold text-slate-900 mt-1",children:T.length})]})]}),e.jsxs("div",{className:"rounded-2xl border border-slate-100 bg-white p-4 shadow-sm",children:[e.jsx("p",{className:"text-sm font-semibold text-slate-700 mb-3",children:"Lịch sử chấm công gần đây"}),T.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Chưa có dữ liệu chấm công."}):e.jsx("ul",{className:"space-y-2 max-h-60 overflow-y-auto pr-1",children:T.slice(0,8).map(n=>{const d=new Date(n.timestamp);return e.jsxs("li",{className:"flex items-center justify-between rounded-xl bg-slate-50 px-4 py-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-slate-900",children:n.type==="checkin"?"Check-in":"Check-out"}),e.jsxs("p",{className:"text-xs text-slate-500",children:[d.toLocaleDateString("vi-VN")," • ",d.toLocaleTimeString("vi-VN")]})]}),typeof n.durationHours=="number"&&n.durationHours>0&&e.jsxs("span",{className:"text-xs font-semibold text-emerald-600",children:["+",n.durationHours.toFixed(2),"h"]})]},n.id)})})]})]})]}):e.jsx("p",{children:"Không tìm thấy thông tin đăng nhập. Vui lòng quay lại trang chủ và đăng nhập lại để chấm công."})})]}),e.jsx("footer",{className:"chan-trang-cham-cong",children:e.jsx(Q,{to:"/",className:"nut-quay-lai",children:"← Quay lại trang chủ"})})]})})};export{ae as default};
